<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#000000">
<title>LinusCam</title>
<link rel="manifest" href="manifest.json">
<style>
  *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

  :root {
    --safe-top: env(safe-area-inset-top, 0px);
    --safe-bottom: env(safe-area-inset-bottom, 0px);
    --ui-bg: rgba(0,0,0,0.55);
    --ui-bg-solid: #1a1a1a;
    --text-primary: #ffffff;
    --text-secondary: rgba(255,255,255,0.7);
    --accent: #0a84ff;
    --danger: #ff453a;
    --success: #30d158;
    --font: -apple-system, BlinkMacSystemFont, "Segoe UI", system-ui, sans-serif;
  }

  html, body {
    height: 100%; width: 100%;
    overflow: hidden;
    background: #000;
    font-family: var(--font);
    color: var(--text-primary);
    touch-action: manipulation;
  }

  /* ‚îÄ‚îÄ‚îÄ Camera View ‚îÄ‚îÄ‚îÄ */
  #cameraView {
    position: fixed; inset: 0;
    display: flex; flex-direction: column;
    background: #000;
  }

  #videoContainer {
    flex: 1; position: relative; overflow: hidden;
    display: flex; align-items: center; justify-content: center;
  }

  #video {
    width: 100%; height: 100%;
    object-fit: cover;
  }

  #canvas { display: none; }

  /* Top bar */
  .top-bar {
    position: absolute; top: 0; left: 0; right: 0;
    padding: calc(var(--safe-top) + 12px) 16px 12px;
    background: linear-gradient(to bottom, rgba(0,0,0,0.6) 0%, transparent 100%);
    display: flex; align-items: center; justify-content: space-between;
    z-index: 10;
  }

  .top-btn {
    width: 40px; height: 40px;
    border-radius: 50%;
    background: var(--ui-bg);
    backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
    border: none; color: white;
    display: flex; align-items: center; justify-content: center;
    cursor: pointer; font-size: 18px;
  }

  .top-btn:active { transform: scale(0.9); }

  .flash-indicator {
    font-size: 13px; font-weight: 600;
    color: var(--text-secondary);
    letter-spacing: 0.5px;
  }

  /* Bottom controls */
  .bottom-controls {
    position: absolute; bottom: 0; left: 0; right: 0;
    padding: 20px 24px calc(var(--safe-bottom) + 20px);
    background: linear-gradient(to top, rgba(0,0,0,0.7) 0%, transparent 100%);
    display: flex; flex-direction: column; align-items: center; gap: 20px;
    z-index: 10;
  }

  /* Recording indicator */
  .recording-strip {
    display: none;
    align-items: center; gap: 8px;
    padding: 6px 14px;
    background: rgba(255,69,58,0.25);
    border-radius: 20px;
    backdrop-filter: blur(8px);
    font-size: 13px; font-weight: 500;
    color: var(--danger);
  }

  .recording-strip.active { display: flex; }

  .rec-dot {
    width: 8px; height: 8px;
    border-radius: 50%;
    background: var(--danger);
    animation: pulse 1s ease-in-out infinite;
  }

  @keyframes pulse { 0%,100% { opacity: 1; } 50% { opacity: 0.3; } }

  .shutter-row {
    display: flex; align-items: center; justify-content: center;
    width: 100%; gap: 40px;
  }

  .side-btn {
    width: 48px; height: 48px;
    border-radius: 50%;
    background: var(--ui-bg);
    backdrop-filter: blur(12px);
    border: none; color: white;
    display: flex; align-items: center; justify-content: center;
    cursor: pointer; font-size: 20px;
  }

  .side-btn:active { transform: scale(0.9); }

  /* Thumbnail preview */
  .thumb-btn {
    width: 48px; height: 48px;
    border-radius: 10px;
    border: 2px solid rgba(255,255,255,0.4);
    overflow: hidden;
    background: var(--ui-bg);
    cursor: pointer;
  }

  .thumb-btn img {
    width: 100%; height: 100%;
    object-fit: cover;
  }

  .thumb-btn.empty {
    display: flex; align-items: center; justify-content: center;
    font-size: 20px;
  }

  /* Shutter button */
  .shutter-btn {
    width: 72px; height: 72px;
    border-radius: 50%;
    border: 4px solid rgba(255,255,255,0.9);
    background: transparent;
    cursor: pointer;
    position: relative;
    transition: transform 0.1s;
  }

  .shutter-btn::after {
    content: '';
    position: absolute;
    inset: 4px;
    border-radius: 50%;
    background: rgba(255,255,255,0.95);
    transition: all 0.15s;
  }

  .shutter-btn:active { transform: scale(0.93); }
  .shutter-btn:active::after { background: rgba(255,255,255,0.7); }

  .shutter-btn.recording { border-color: var(--danger); }
  .shutter-btn.recording::after {
    background: var(--danger);
    inset: 18px;
    border-radius: 6px;
  }

  /* Mode labels */
  .mode-strip {
    display: flex; gap: 20px;
    font-size: 13px; font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.8px;
  }

  .mode-strip span {
    color: var(--text-secondary);
    cursor: pointer;
    padding: 4px 0;
    position: relative;
  }

  .mode-strip span.active {
    color: #ffd60a;
  }

  /* ‚îÄ‚îÄ‚îÄ Review / Preview View ‚îÄ‚îÄ‚îÄ */
  #reviewView {
    position: fixed; inset: 0;
    background: #000;
    display: none; flex-direction: column;
    z-index: 100;
  }

  #reviewView.active { display: flex; }

  .review-top {
    padding: calc(var(--safe-top) + 12px) 16px 12px;
    display: flex; align-items: center; justify-content: space-between;
    background: var(--ui-bg-solid);
  }

  .review-btn {
    padding: 8px 16px;
    border-radius: 20px;
    border: none;
    font-size: 15px; font-weight: 600;
    cursor: pointer;
    font-family: var(--font);
  }

  .review-btn:active { transform: scale(0.95); }

  .review-btn.cancel {
    background: transparent;
    color: var(--accent);
  }

  .review-btn.save {
    background: var(--accent);
    color: white;
  }

  .review-btn.save:disabled {
    opacity: 0.4;
    cursor: default;
  }

  .review-image-wrap {
    flex: 1;
    display: flex; align-items: center; justify-content: center;
    overflow: hidden;
    background: #000;
  }

  #reviewImage {
    max-width: 100%; max-height: 100%;
    object-fit: contain;
  }

  .review-bottom {
    background: var(--ui-bg-solid);
    padding: 16px 16px calc(var(--safe-bottom) + 16px);
    display: flex; flex-direction: column; gap: 12px;
  }

  .voice-note-section {
    display: flex; flex-direction: column; gap: 8px;
  }

  .voice-note-header {
    display: flex; align-items: center; justify-content: space-between;
  }

  .voice-note-label {
    font-size: 13px; font-weight: 600;
    color: var(--text-secondary);
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .voice-status {
    font-size: 12px;
    color: var(--text-secondary);
    display: flex; align-items: center; gap: 4px;
  }

  .voice-status.listening { color: var(--danger); }
  .voice-status.done { color: var(--success); }

  #noteText {
    width: 100%;
    min-height: 60px;
    padding: 12px;
    border-radius: 12px;
    border: 1px solid rgba(255,255,255,0.15);
    background: rgba(255,255,255,0.08);
    color: var(--text-primary);
    font-size: 15px;
    font-family: var(--font);
    line-height: 1.4;
    resize: none;
    outline: none;
    transition: border-color 0.2s;
  }

  #noteText:focus { border-color: var(--accent); }
  #noteText::placeholder { color: rgba(255,255,255,0.3); }

  .voice-actions {
    display: flex; gap: 8px;
  }

  .mic-btn {
    flex: 1;
    padding: 10px;
    border-radius: 10px;
    border: none;
    font-size: 14px; font-weight: 600;
    cursor: pointer;
    font-family: var(--font);
    display: flex; align-items: center; justify-content: center; gap: 6px;
    transition: all 0.2s;
  }

  .mic-btn.record {
    background: rgba(255,69,58,0.15);
    color: var(--danger);
  }

  .mic-btn.record.listening {
    background: var(--danger);
    color: white;
    animation: mic-pulse 1.5s ease-in-out infinite;
  }

  @keyframes mic-pulse {
    0%, 100% { box-shadow: 0 0 0 0 rgba(255,69,58,0.3); }
    50% { box-shadow: 0 0 0 8px rgba(255,69,58,0); }
  }

  .mic-btn.clear {
    flex: 0 0 auto;
    padding: 10px 16px;
    background: rgba(255,255,255,0.1);
    color: var(--text-secondary);
  }

  /* ‚îÄ‚îÄ‚îÄ Flash overlay ‚îÄ‚îÄ‚îÄ */
  .flash-overlay {
    position: fixed; inset: 0;
    background: white;
    opacity: 0;
    pointer-events: none;
    z-index: 200;
    transition: opacity 0.05s;
  }

  .flash-overlay.flash {
    opacity: 0.8;
    transition: opacity 0.0s;
  }

  /* ‚îÄ‚îÄ‚îÄ Toast ‚îÄ‚îÄ‚îÄ */
  .toast {
    position: fixed;
    top: calc(var(--safe-top) + 60px);
    left: 50%; transform: translateX(-50%) translateY(-20px);
    padding: 10px 20px;
    border-radius: 20px;
    background: var(--ui-bg-solid);
    backdrop-filter: blur(20px);
    font-size: 14px; font-weight: 500;
    color: var(--text-primary);
    z-index: 300;
    opacity: 0;
    pointer-events: none;
    transition: all 0.3s ease;
    white-space: nowrap;
  }

  .toast.show {
    opacity: 1;
    transform: translateX(-50%) translateY(0);
  }

  /* ‚îÄ‚îÄ‚îÄ Permission screen ‚îÄ‚îÄ‚îÄ */
  #permissionScreen {
    position: fixed; inset: 0;
    background: #000;
    display: flex; flex-direction: column;
    align-items: center; justify-content: center;
    gap: 20px; padding: 40px;
    z-index: 500;
    text-align: center;
  }

  #permissionScreen.hidden { display: none; }

  .perm-icon { font-size: 64px; margin-bottom: 8px; }

  .perm-title {
    font-size: 22px; font-weight: 700;
    line-height: 1.3;
  }

  .perm-desc {
    font-size: 15px;
    color: var(--text-secondary);
    line-height: 1.5;
    max-width: 300px;
  }

  .perm-btn {
    padding: 14px 32px;
    border-radius: 14px;
    border: none;
    background: var(--accent);
    color: white;
    font-size: 17px; font-weight: 600;
    cursor: pointer;
    font-family: var(--font);
    margin-top: 8px;
  }

  .perm-btn:active { transform: scale(0.96); }

  /* ‚îÄ‚îÄ‚îÄ Gallery View (simple) ‚îÄ‚îÄ‚îÄ */
  #galleryView {
    position: fixed; inset: 0;
    background: #000;
    display: none; flex-direction: column;
    z-index: 100;
  }

  #galleryView.active { display: flex; }

  .gallery-top {
    padding: calc(var(--safe-top) + 12px) 16px 12px;
    display: flex; align-items: center; justify-content: space-between;
    background: var(--ui-bg-solid);
  }

  .gallery-title {
    font-size: 17px; font-weight: 600;
  }

  .gallery-grid {
    flex: 1; overflow-y: auto;
    padding: 2px;
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 2px;
  }

  .gallery-item {
    aspect-ratio: 1;
    overflow: hidden;
    cursor: pointer;
    position: relative;
  }

  .gallery-item img {
    width: 100%; height: 100%;
    object-fit: cover;
  }

  .gallery-item .has-note {
    position: absolute;
    bottom: 4px; right: 4px;
    background: rgba(0,0,0,0.6);
    border-radius: 4px;
    padding: 2px 5px;
    font-size: 10px;
  }

  .gallery-empty {
    flex: 1;
    display: flex; flex-direction: column;
    align-items: center; justify-content: center;
    gap: 12px;
    color: var(--text-secondary);
  }

  .gallery-empty-icon { font-size: 48px; opacity: 0.5; }
  .gallery-empty-text { font-size: 15px; }

  /* Detail view */
  #detailView {
    position: fixed; inset: 0;
    background: #000;
    display: none; flex-direction: column;
    z-index: 150;
  }

  #detailView.active { display: flex; }

  .detail-top {
    padding: calc(var(--safe-top) + 12px) 16px 12px;
    display: flex; align-items: center; justify-content: space-between;
    background: var(--ui-bg-solid);
  }

  .detail-image-wrap {
    flex: 1;
    display: flex; align-items: center; justify-content: center;
    overflow: hidden;
  }

  #detailImage {
    max-width: 100%; max-height: 100%;
    object-fit: contain;
  }

  .detail-bottom {
    background: var(--ui-bg-solid);
    padding: 16px 16px calc(var(--safe-bottom) + 16px);
  }

  .detail-note-label {
    font-size: 12px; font-weight: 600;
    color: var(--text-secondary);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 6px;
  }

  .detail-note-text {
    font-size: 15px;
    line-height: 1.5;
    color: var(--text-primary);
  }

  .detail-note-empty {
    font-size: 14px;
    color: var(--text-secondary);
    font-style: italic;
  }

  .detail-actions {
    display: flex; gap: 8px;
    margin-top: 12px;
  }

  .detail-action-btn {
    flex: 1;
    padding: 10px;
    border-radius: 10px;
    border: none;
    font-size: 14px; font-weight: 600;
    cursor: pointer;
    font-family: var(--font);
    display: flex; align-items: center; justify-content: center; gap: 6px;
  }

  .detail-action-btn.download {
    background: var(--accent);
    color: white;
  }

  .detail-action-btn.delete {
    background: rgba(255,69,58,0.15);
    color: var(--danger);
  }

  /* ‚îÄ‚îÄ‚îÄ EXIF Viewer ‚îÄ‚îÄ‚îÄ */
  #viewerView {
    position: fixed; inset: 0;
    background: #000;
    display: none; flex-direction: column;
    z-index: 100;
  }

  #viewerView.active { display: flex; }

  .viewer-top {
    padding: calc(var(--safe-top) + 12px) 16px 12px;
    display: flex; align-items: center; justify-content: space-between;
    background: var(--ui-bg-solid);
    flex-shrink: 0;
  }

  .viewer-content {
    flex: 1;
    overflow-y: auto;
    -webkit-overflow-scrolling: touch;
  }

  .viewer-empty {
    display: flex;
    align-items: center; justify-content: center;
    min-height: 100%;
    padding: 40px 24px;
  }

  .viewer-drop-zone {
    display: flex; flex-direction: column;
    align-items: center; text-align: center;
    padding: 40px 24px;
    border: 2px dashed rgba(255,255,255,0.15);
    border-radius: 20px;
    width: 100%; max-width: 340px;
  }

  .viewer-drop-zone.dragover {
    border-color: var(--accent);
    background: rgba(10,132,255,0.08);
  }

  .viewer-pick-btn {
    display: inline-block;
    padding: 12px 28px;
    border-radius: 12px;
    background: var(--accent);
    color: white;
    font-size: 16px; font-weight: 600;
    cursor: pointer;
    font-family: var(--font);
    text-align: center;
  }

  .viewer-pick-btn:active { transform: scale(0.96); }

  .viewer-pick-btn.small {
    padding: 10px 20px;
    font-size: 14px;
    width: 100%;
  }

  .viewer-result {
    display: flex; flex-direction: column;
  }

  .viewer-image-wrap {
    width: 100%;
    max-height: 45vh;
    overflow: hidden;
    display: flex; align-items: center; justify-content: center;
    background: #111;
  }

  #viewerImage {
    width: 100%;
    max-height: 45vh;
    object-fit: contain;
  }

  .viewer-meta {
    padding: 20px 16px calc(var(--safe-bottom) + 20px);
    display: flex; flex-direction: column;
    gap: 16px;
  }

  .viewer-meta-section {
    display: flex; flex-direction: column; gap: 4px;
  }

  .viewer-meta-label {
    font-size: 11px; font-weight: 700;
    color: var(--text-secondary);
    text-transform: uppercase;
    letter-spacing: 0.8px;
  }

  .viewer-meta-value {
    font-size: 15px;
    line-height: 1.5;
    color: var(--text-primary);
  }

  .viewer-meta-value.empty {
    color: var(--text-secondary);
    font-style: italic;
    font-size: 14px;
  }

  .viewer-meta-value.highlight {
    background: rgba(10,132,255,0.12);
    border-left: 3px solid var(--accent);
    padding: 10px 14px;
    border-radius: 0 8px 8px 0;
    font-size: 16px;
  }

  /* Mode bar for camera - adds Viewer tab */
  .mode-strip span.viewer-mode {
    color: var(--accent);
  }
</style>
</head>
<body>

<!-- Permission Screen -->
<div id="permissionScreen">
  <div class="perm-icon">üì∏</div>
  <div class="perm-title">LinusCam</div>
  <div class="perm-desc">Capture photos with voice notes embedded right in the image metadata. Grant camera access to get started.</div>
  <button class="perm-btn" id="grantPermBtn">Enable Camera</button>
  <button class="perm-btn" id="viewerOnlyBtn" style="background:transparent;color:var(--accent);border:1px solid var(--accent);margin-top:0">Open Viewer Instead</button>
</div>

<!-- Camera View -->
<div id="cameraView" style="display:none">
  <div id="videoContainer">
    <video id="video" autoplay playsinline muted></video>

    <div class="top-bar">
      <button class="top-btn" id="flipBtn">‚ü≥</button>
      <span class="flash-indicator">LINUSCAM</span>
      <button class="top-btn" id="galleryBtn">‚äû</button>
    </div>

    <div class="bottom-controls">
      <div class="recording-strip" id="recStrip">
        <div class="rec-dot"></div>
        <span id="recLabel">Listening...</span>
      </div>

      <div class="mode-strip">
        <span class="active">Photo</span>
        <span class="viewer-mode" id="openViewerMode">Viewer</span>
      </div>

      <div class="shutter-row">
        <div class="thumb-btn empty" id="thumbBtn">üñº</div>
        <button class="shutter-btn" id="shutterBtn"></button>
        <button class="side-btn" id="micToggle">üé§</button>
      </div>
    </div>
  </div>
  <canvas id="canvas"></canvas>
</div>

<!-- Review View -->
<div id="reviewView">
  <div class="review-top">
    <button class="review-btn cancel" id="reviewCancel">Retake</button>
    <button class="review-btn save" id="reviewSave">Save</button>
  </div>
  <div class="review-image-wrap">
    <img id="reviewImage" alt="Captured photo">
  </div>
  <div class="review-bottom">
    <div class="voice-note-section">
      <div class="voice-note-header">
        <span class="voice-note-label">Voice Note</span>
        <span class="voice-status" id="voiceStatus"></span>
      </div>
      <textarea id="noteText" placeholder="Tap mic to add a voice note, or type here..." rows="3"></textarea>
      <div class="voice-actions">
        <button class="mic-btn record" id="reviewMicBtn">üé§ Record Note</button>
        <button class="mic-btn clear" id="clearNoteBtn">‚úï</button>
      </div>
    </div>
  </div>
</div>

<!-- Gallery View -->
<div id="galleryView">
  <div class="gallery-top">
    <button class="review-btn cancel" id="galleryBack">‚Üê Back</button>
    <span class="gallery-title">LinusCam</span>
    <span style="width:60px"></span>
  </div>
  <div class="gallery-grid" id="galleryGrid"></div>
  <div class="gallery-empty" id="galleryEmpty" style="display:none">
    <div class="gallery-empty-icon">üì∑</div>
    <div class="gallery-empty-text">No photos yet</div>
  </div>
</div>

<!-- Detail View -->
<div id="detailView">
  <div class="detail-top">
    <button class="review-btn cancel" id="detailBack">‚Üê Back</button>
    <span style="font-size:15px;font-weight:600" id="detailDate"></span>
    <span style="width:40px"></span>
  </div>
  <div class="detail-image-wrap">
    <img id="detailImage" alt="Photo detail">
  </div>
  <div class="detail-bottom">
    <div class="detail-note-label">Voice Note</div>
    <div id="detailNoteContent"></div>
    <div class="detail-actions">
      <button class="detail-action-btn download" id="detailDownload">‚§ì Download</button>
      <button class="detail-action-btn delete" id="detailDelete">‚úï Delete</button>
    </div>
  </div>
</div>

<!-- EXIF Viewer View -->
<div id="viewerView">
  <div class="viewer-top">
    <button class="review-btn cancel" id="viewerBack">‚Üê Back</button>
    <span class="gallery-title">EXIF Viewer</span>
    <span style="width:60px"></span>
  </div>
  <div class="viewer-content" id="viewerContent">
    <div class="viewer-empty" id="viewerEmpty">
      <div class="viewer-drop-zone" id="dropZone">
        <div style="font-size:48px;margin-bottom:12px">üîç</div>
        <div style="font-size:17px;font-weight:600;margin-bottom:6px">View Photo Metadata</div>
        <div style="font-size:14px;color:var(--text-secondary);margin-bottom:20px;line-height:1.5;max-width:260px">
          Pick any JPEG to read the voice note embedded in its EXIF data
        </div>
        <label class="viewer-pick-btn" for="viewerFileInput">Choose Photo</label>
        <input type="file" id="viewerFileInput" accept="image/jpeg,image/jpg,.jpg,.jpeg" style="display:none">
      </div>
    </div>
    <div class="viewer-result" id="viewerResult" style="display:none">
      <div class="viewer-image-wrap">
        <img id="viewerImage" alt="Viewed photo">
      </div>
      <div class="viewer-meta">
        <div class="viewer-meta-section">
          <div class="viewer-meta-label">Voice Note / Description</div>
          <div class="viewer-meta-value" id="viewerNote"></div>
        </div>
        <div class="viewer-meta-section">
          <div class="viewer-meta-label">User Comment</div>
          <div class="viewer-meta-value" id="viewerComment"></div>
        </div>
        <div class="viewer-meta-section">
          <div class="viewer-meta-label">Date Taken</div>
          <div class="viewer-meta-value" id="viewerDate"></div>
        </div>
        <div class="viewer-meta-section">
          <div class="viewer-meta-label">Software</div>
          <div class="viewer-meta-value" id="viewerSoftware"></div>
        </div>
        <div class="viewer-meta-section">
          <div class="viewer-meta-label">Camera / Device</div>
          <div class="viewer-meta-value" id="viewerCamera"></div>
        </div>
        <div class="viewer-meta-section">
          <div class="viewer-meta-label">Resolution</div>
          <div class="viewer-meta-value" id="viewerResolution"></div>
        </div>
        <div style="padding-top:8px">
          <label class="viewer-pick-btn small" for="viewerFileInput">Choose Another Photo</label>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Flash overlay -->
<div class="flash-overlay" id="flashOverlay"></div>

<!-- Toast -->
<div class="toast" id="toast"></div>

<!-- piexif for EXIF manipulation (lightweight, handles writing metadata into JPEG) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/piexifjs/1.0.6/piexif.min.js"></script>

<script>
(function() {
  'use strict';

  // ‚îÄ‚îÄ‚îÄ State ‚îÄ‚îÄ‚îÄ
  let stream = null;
  let facingMode = 'environment';
  let capturedDataUrl = null;
  let isListening = false;
  let recognition = null;
  let photos = []; // {dataUrl, note, timestamp}
  let currentDetailIdx = -1;
  let autoRecordAfterShutter = false;

  // ‚îÄ‚îÄ‚îÄ Elements ‚îÄ‚îÄ‚îÄ
  const $ = id => document.getElementById(id);
  const video = $('video');
  const canvas = $('canvas');
  const ctx = canvas.getContext('2d');

  // ‚îÄ‚îÄ‚îÄ IndexedDB for persistence ‚îÄ‚îÄ‚îÄ
  const DB_NAME = 'linuscam_db';
  const DB_VERSION = 1;
  const STORE_NAME = 'photos';
  let db = null;

  function openDB() {
    return new Promise((resolve, reject) => {
      const req = indexedDB.open(DB_NAME, DB_VERSION);
      req.onupgradeneeded = e => {
        const d = e.target.result;
        if (!d.objectStoreNames.contains(STORE_NAME)) {
          d.createObjectStore(STORE_NAME, { keyPath: 'id', autoIncrement: true });
        }
      };
      req.onsuccess = e => { db = e.target.result; resolve(db); };
      req.onerror = e => reject(e);
    });
  }

  function dbPut(photo) {
    return new Promise((resolve, reject) => {
      const tx = db.transaction(STORE_NAME, 'readwrite');
      const store = tx.objectStore(STORE_NAME);
      const req = store.add(photo);
      req.onsuccess = () => resolve(req.result);
      req.onerror = e => reject(e);
    });
  }

  function dbGetAll() {
    return new Promise((resolve, reject) => {
      const tx = db.transaction(STORE_NAME, 'readonly');
      const store = tx.objectStore(STORE_NAME);
      const req = store.getAll();
      req.onsuccess = () => resolve(req.result);
      req.onerror = e => reject(e);
    });
  }

  function dbDelete(id) {
    return new Promise((resolve, reject) => {
      const tx = db.transaction(STORE_NAME, 'readwrite');
      const store = tx.objectStore(STORE_NAME);
      const req = store.delete(id);
      req.onsuccess = () => resolve();
      req.onerror = e => reject(e);
    });
  }

  // ‚îÄ‚îÄ‚îÄ Camera ‚îÄ‚îÄ‚îÄ
  async function startCamera() {
    if (stream) stream.getTracks().forEach(t => t.stop());
    try {
      stream = await navigator.mediaDevices.getUserMedia({
        video: { facingMode, width: { ideal: 4032 }, height: { ideal: 3024 } },
        audio: false
      });
      video.srcObject = stream;
      $('permissionScreen').classList.add('hidden');
      $('cameraView').style.display = 'flex';
    } catch (err) {
      console.error('Camera error:', err);
      showToast('Camera access denied');
    }
  }

  // ‚îÄ‚îÄ‚îÄ Capture ‚îÄ‚îÄ‚îÄ
  function capturePhoto() {
    const track = stream.getVideoTracks()[0];
    const settings = track.getSettings();
    canvas.width = settings.width || video.videoWidth;
    canvas.height = settings.height || video.videoHeight;

    // Mirror front camera
    if (facingMode === 'user') {
      ctx.translate(canvas.width, 0);
      ctx.scale(-1, 1);
    }
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
    ctx.setTransform(1, 0, 0, 1, 0, 0);

    // Flash effect
    const flash = $('flashOverlay');
    flash.classList.add('flash');
    setTimeout(() => flash.classList.remove('flash'), 150);

    capturedDataUrl = canvas.toDataURL('image/jpeg', 0.92);

    // Show review
    $('reviewImage').src = capturedDataUrl;
    $('reviewView').classList.add('active');
    $('noteText').value = '';
    updateVoiceStatus('');

    // Auto-start recording if mic was toggled on
    if (autoRecordAfterShutter) {
      setTimeout(() => startListening(), 300);
    }
  }

  // ‚îÄ‚îÄ‚îÄ EXIF Writing ‚îÄ‚îÄ‚îÄ
  function embedNoteInExif(dataUrl, note) {
    try {
      // Read existing EXIF or create new
      let exifObj;
      try {
        exifObj = piexif.load(dataUrl);
      } catch(e) {
        exifObj = { '0th': {}, 'Exif': {}, 'GPS': {}, '1st': {}, 'thumbnail': null };
      }

      // Write note into ImageDescription and UserComment
      exifObj['0th'][piexif.ImageIFD.ImageDescription] = note;

      // UserComment needs special encoding
      const userComment = 'ASCII\0\0\0' + note;
      exifObj['Exif'][piexif.ExifIFD.UserComment] = userComment;

      // Also set the DateTimeOriginal
      const now = new Date();
      const dateStr = now.getFullYear() + ':' +
        String(now.getMonth()+1).padStart(2,'0') + ':' +
        String(now.getDate()).padStart(2,'0') + ' ' +
        String(now.getHours()).padStart(2,'0') + ':' +
        String(now.getMinutes()).padStart(2,'0') + ':' +
        String(now.getSeconds()).padStart(2,'0');
      exifObj['Exif'][piexif.ExifIFD.DateTimeOriginal] = dateStr;
      exifObj['0th'][piexif.ImageIFD.DateTime] = dateStr;

      // Software tag
      exifObj['0th'][piexif.ImageIFD.Software] = 'LinusCam PWA';

      const exifBytes = piexif.dump(exifObj);
      return piexif.insert(exifBytes, dataUrl);
    } catch (err) {
      console.error('EXIF write error:', err);
      return dataUrl; // Return original if EXIF fails
    }
  }

  // ‚îÄ‚îÄ‚îÄ Speech Recognition ‚îÄ‚îÄ‚îÄ
  function initSpeechRecognition() {
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (!SpeechRecognition) return null;

    const r = new SpeechRecognition();
    r.continuous = true;
    r.interimResults = true;
    r.lang = 'en-US';

    let finalTranscript = '';

    r.onresult = (e) => {
      let interim = '';
      for (let i = e.resultIndex; i < e.results.length; i++) {
        const t = e.results[i][0].transcript;
        if (e.results[i].isFinal) {
          finalTranscript += t + ' ';
        } else {
          interim = t;
        }
      }
      $('noteText').value = (finalTranscript + interim).trim();
    };

    r.onend = () => {
      isListening = false;
      $('reviewMicBtn').classList.remove('listening');
      $('reviewMicBtn').innerHTML = 'üé§ Record Note';
      $('recStrip').classList.remove('active');
      updateVoiceStatus($('noteText').value ? 'done' : '');
      finalTranscript = $('noteText').value + ' ';
    };

    r.onerror = (e) => {
      console.error('Speech error:', e.error);
      isListening = false;
      $('reviewMicBtn').classList.remove('listening');
      $('reviewMicBtn').innerHTML = 'üé§ Record Note';
      $('recStrip').classList.remove('active');
      if (e.error === 'not-allowed') {
        showToast('Microphone access denied');
      }
    };

    return r;
  }

  function startListening() {
    if (!recognition) recognition = initSpeechRecognition();
    if (!recognition) {
      showToast('Speech recognition not supported');
      return;
    }

    if (isListening) {
      recognition.stop();
      return;
    }

    isListening = true;
    $('reviewMicBtn').classList.add('listening');
    $('reviewMicBtn').innerHTML = '‚èπ Stop';
    $('recStrip').classList.add('active');
    updateVoiceStatus('listening');

    try {
      recognition.start();
    } catch(e) {
      // Already started
      recognition.stop();
      setTimeout(() => recognition.start(), 100);
    }
  }

  function updateVoiceStatus(state) {
    const el = $('voiceStatus');
    el.className = 'voice-status';
    if (state === 'listening') {
      el.classList.add('listening');
      el.innerHTML = '<span class="rec-dot" style="width:6px;height:6px"></span> Listening';
    } else if (state === 'done') {
      el.classList.add('done');
      el.textContent = '‚úì Note added';
    } else {
      el.textContent = '';
    }
  }

  // ‚îÄ‚îÄ‚îÄ Save Photo ‚îÄ‚îÄ‚îÄ
  async function savePhoto() {
    const note = $('noteText').value.trim();
    let finalDataUrl = capturedDataUrl;

    // Embed note in EXIF
    if (note) {
      finalDataUrl = embedNoteInExif(capturedDataUrl, note);
    } else {
      // Still add basic EXIF
      finalDataUrl = embedNoteInExif(capturedDataUrl, '');
    }

    const photo = {
      dataUrl: finalDataUrl,
      note: note,
      timestamp: Date.now()
    };

    // Save to IndexedDB
    const id = await dbPut(photo);
    photo.id = id;
    photos.push(photo);

    // Update thumbnail
    updateThumbnail(photo);

    // Close review
    $('reviewView').classList.remove('active');
    if (isListening && recognition) recognition.stop();

    showToast(note ? 'Saved with voice note ‚úì' : 'Photo saved ‚úì');

    // Trigger download (this is how we "save to photos" in PWA context)
    triggerDownload(finalDataUrl, photo.timestamp);
  }

  function triggerDownload(dataUrl, timestamp) {
    const link = document.createElement('a');
    const date = new Date(timestamp);
    const fname = `LinusCam_${date.getFullYear()}${String(date.getMonth()+1).padStart(2,'0')}${String(date.getDate()).padStart(2,'0')}_${String(date.getHours()).padStart(2,'0')}${String(date.getMinutes()).padStart(2,'0')}${String(date.getSeconds()).padStart(2,'0')}.jpg`;
    link.href = dataUrl;
    link.download = fname;
    link.click();
  }

  function updateThumbnail(photo) {
    const btn = $('thumbBtn');
    btn.classList.remove('empty');
    btn.innerHTML = `<img src="${photo.dataUrl}" alt="Last photo">`;
  }

  // ‚îÄ‚îÄ‚îÄ Gallery ‚îÄ‚îÄ‚îÄ
  async function openGallery() {
    photos = await dbGetAll();
    const grid = $('galleryGrid');
    const empty = $('galleryEmpty');

    grid.innerHTML = '';

    if (photos.length === 0) {
      grid.style.display = 'none';
      empty.style.display = 'flex';
    } else {
      grid.style.display = 'grid';
      empty.style.display = 'none';

      // Reverse to show newest first
      [...photos].reverse().forEach((p, i) => {
        const idx = photos.length - 1 - i;
        const item = document.createElement('div');
        item.className = 'gallery-item';
        item.innerHTML = `<img src="${p.dataUrl}" alt="Photo">` +
          (p.note ? '<div class="has-note">üé§</div>' : '');
        item.addEventListener('click', () => openDetail(idx));
        grid.appendChild(item);
      });
    }

    $('galleryView').classList.add('active');
  }

  function openDetail(idx) {
    currentDetailIdx = idx;
    const photo = photos[idx];
    $('detailImage').src = photo.dataUrl;
    $('detailDate').textContent = new Date(photo.timestamp).toLocaleDateString();

    const noteEl = $('detailNoteContent');

    // Read EXIF back from the actual image data to prove round-trip
    let exifNote = '';
    try {
      const exifObj = piexif.load(photo.dataUrl);
      exifNote = exifObj['0th'][piexif.ImageIFD.ImageDescription] || '';
    } catch(e) {}

    if (photo.note || exifNote) {
      const displayNote = exifNote || photo.note;
      noteEl.innerHTML = `<div class="detail-note-text">${escapeHtml(displayNote)}</div>` +
        (exifNote ? '<div style="font-size:11px;color:var(--success);margin-top:6px;font-weight:600">‚úì Verified from EXIF metadata</div>' : '');
    } else {
      noteEl.innerHTML = '<div class="detail-note-empty">No voice note</div>';
    }

    $('detailView').classList.add('active');
  }

  function escapeHtml(str) {
    const div = document.createElement('div');
    div.textContent = str;
    return div.innerHTML;
  }

  // ‚îÄ‚îÄ‚îÄ Toast ‚îÄ‚îÄ‚îÄ
  function showToast(msg) {
    const t = $('toast');
    t.textContent = msg;
    t.classList.add('show');
    setTimeout(() => t.classList.remove('show'), 2500);
  }

  // ‚îÄ‚îÄ‚îÄ Event Listeners ‚îÄ‚îÄ‚îÄ
  $('grantPermBtn').addEventListener('click', startCamera);

  $('shutterBtn').addEventListener('click', capturePhoto);

  $('flipBtn').addEventListener('click', () => {
    facingMode = facingMode === 'environment' ? 'user' : 'environment';
    startCamera();
  });

  $('micToggle').addEventListener('click', () => {
    autoRecordAfterShutter = !autoRecordAfterShutter;
    $('micToggle').style.background = autoRecordAfterShutter
      ? 'rgba(255,69,58,0.4)' : 'var(--ui-bg)';
    showToast(autoRecordAfterShutter ? 'Auto-record ON' : 'Auto-record OFF');
  });

  $('reviewCancel').addEventListener('click', () => {
    $('reviewView').classList.remove('active');
    if (isListening && recognition) recognition.stop();
  });

  $('reviewSave').addEventListener('click', savePhoto);

  $('reviewMicBtn').addEventListener('click', startListening);

  $('clearNoteBtn').addEventListener('click', () => {
    $('noteText').value = '';
    if (isListening && recognition) recognition.stop();
    updateVoiceStatus('');
  });

  $('galleryBtn').addEventListener('click', openGallery);
  $('galleryBack').addEventListener('click', () => $('galleryView').classList.remove('active'));
  $('detailBack').addEventListener('click', () => $('detailView').classList.remove('active'));

  $('detailDownload').addEventListener('click', () => {
    if (currentDetailIdx >= 0) {
      const p = photos[currentDetailIdx];
      triggerDownload(p.dataUrl, p.timestamp);
    }
  });

  $('detailDelete').addEventListener('click', async () => {
    if (currentDetailIdx >= 0) {
      const p = photos[currentDetailIdx];
      await dbDelete(p.id);
      photos.splice(currentDetailIdx, 1);
      $('detailView').classList.remove('active');
      openGallery(); // Refresh
      showToast('Photo deleted');
    }
  });

  $('thumbBtn').addEventListener('click', openGallery);

  // ‚îÄ‚îÄ‚îÄ EXIF Viewer ‚îÄ‚îÄ‚îÄ
  function openViewer() {
    $('viewerView').classList.add('active');
  }

  function readExifFromFile(file) {
    const reader = new FileReader();
    reader.onload = (e) => {
      const dataUrl = e.target.result;
      $('viewerImage').src = dataUrl;
      $('viewerEmpty').style.display = 'none';
      $('viewerResult').style.display = 'flex';

      // Read EXIF
      try {
        const exifObj = piexif.load(dataUrl);

        // ImageDescription (where we store the voice note)
        const desc = exifObj['0th'][piexif.ImageIFD.ImageDescription];
        const noteEl = $('viewerNote');
        if (desc && desc.trim()) {
          noteEl.textContent = desc;
          noteEl.className = 'viewer-meta-value highlight';
        } else {
          noteEl.textContent = 'No description found';
          noteEl.className = 'viewer-meta-value empty';
        }

        // UserComment
        const rawComment = exifObj['Exif'][piexif.ExifIFD.UserComment];
        const commentEl = $('viewerComment');
        if (rawComment) {
          // UserComment is prefixed with charset identifier (8 bytes)
          let comment = '';
          if (typeof rawComment === 'string') {
            // Try to strip ASCII prefix
            if (rawComment.startsWith('ASCII\0\0\0')) {
              comment = rawComment.substring(8);
            } else {
              comment = rawComment;
            }
          }
          if (comment.trim()) {
            commentEl.textContent = comment;
            commentEl.className = 'viewer-meta-value highlight';
          } else {
            commentEl.textContent = 'No user comment';
            commentEl.className = 'viewer-meta-value empty';
          }
        } else {
          commentEl.textContent = 'No user comment';
          commentEl.className = 'viewer-meta-value empty';
        }

        // Date
        const dateOrig = exifObj['Exif'][piexif.ExifIFD.DateTimeOriginal] ||
                         exifObj['0th'][piexif.ImageIFD.DateTime];
        const dateEl = $('viewerDate');
        if (dateOrig) {
          dateEl.textContent = dateOrig;
          dateEl.className = 'viewer-meta-value';
        } else {
          dateEl.textContent = 'Unknown';
          dateEl.className = 'viewer-meta-value empty';
        }

        // Software
        const sw = exifObj['0th'][piexif.ImageIFD.Software];
        const swEl = $('viewerSoftware');
        if (sw) {
          swEl.textContent = sw;
          swEl.className = 'viewer-meta-value';
        } else {
          swEl.textContent = 'Unknown';
          swEl.className = 'viewer-meta-value empty';
        }

        // Camera make/model
        const make = exifObj['0th'][piexif.ImageIFD.Make] || '';
        const model = exifObj['0th'][piexif.ImageIFD.Model] || '';
        const cameraEl = $('viewerCamera');
        const cameraStr = [make, model].filter(Boolean).join(' ');
        if (cameraStr) {
          cameraEl.textContent = cameraStr;
          cameraEl.className = 'viewer-meta-value';
        } else {
          cameraEl.textContent = 'Unknown';
          cameraEl.className = 'viewer-meta-value empty';
        }

        // Resolution
        const resEl = $('viewerResolution');
        const pw = exifObj['Exif'][piexif.ExifIFD.PixelXDimension];
        const ph = exifObj['Exif'][piexif.ExifIFD.PixelYDimension];
        if (pw && ph) {
          resEl.textContent = `${pw} √ó ${ph}`;
          resEl.className = 'viewer-meta-value';
        } else {
          // Fall back to image natural dimensions
          const img = $('viewerImage');
          img.onload = () => {
            resEl.textContent = `${img.naturalWidth} √ó ${img.naturalHeight}`;
            resEl.className = 'viewer-meta-value';
          };
          resEl.textContent = 'Loading...';
          resEl.className = 'viewer-meta-value empty';
        }

      } catch (err) {
        console.error('EXIF read error:', err);
        $('viewerNote').textContent = 'Could not read EXIF data';
        $('viewerNote').className = 'viewer-meta-value empty';
        $('viewerComment').textContent = 'N/A';
        $('viewerComment').className = 'viewer-meta-value empty';
        $('viewerDate').textContent = 'N/A';
        $('viewerDate').className = 'viewer-meta-value empty';
        $('viewerSoftware').textContent = 'N/A';
        $('viewerSoftware').className = 'viewer-meta-value empty';
        $('viewerCamera').textContent = 'N/A';
        $('viewerCamera').className = 'viewer-meta-value empty';
        $('viewerResolution').textContent = 'N/A';
        $('viewerResolution').className = 'viewer-meta-value empty';
      }
    };
    reader.readAsDataURL(file);
  }

  // File input
  $('viewerFileInput').addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (file) readExifFromFile(file);
  });

  // Drag and drop
  const dropZone = $('dropZone');
  if (dropZone) {
    dropZone.addEventListener('dragover', (e) => {
      e.preventDefault();
      dropZone.classList.add('dragover');
    });
    dropZone.addEventListener('dragleave', () => {
      dropZone.classList.remove('dragover');
    });
    dropZone.addEventListener('drop', (e) => {
      e.preventDefault();
      dropZone.classList.remove('dragover');
      const file = e.dataTransfer.files[0];
      if (file && file.type.startsWith('image/')) {
        readExifFromFile(file);
      }
    });
  }

  // Viewer navigation
  $('viewerBack').addEventListener('click', () => {
    $('viewerView').classList.remove('active');
    // Reset viewer state
    $('viewerEmpty').style.display = 'flex';
    $('viewerResult').style.display = 'none';
    $('viewerFileInput').value = '';
  });

  $('openViewerMode').addEventListener('click', openViewer);

  // Viewer from permission screen (no camera needed)
  $('viewerOnlyBtn').addEventListener('click', () => {
    $('permissionScreen').classList.add('hidden');
    // Don't start camera, just show viewer
    openViewer();
  });

  // ‚îÄ‚îÄ‚îÄ Init ‚îÄ‚îÄ‚îÄ
  openDB().then(async () => {
    photos = await dbGetAll();
    if (photos.length > 0) {
      updateThumbnail(photos[photos.length - 1]);
    }

    // Auto-start camera if permission already granted
    try {
      const result = await navigator.permissions.query({ name: 'camera' });
      if (result.state === 'granted') {
        startCamera();
      }
    } catch(e) {
      // permissions API not supported, user will click button
    }
  });

  // ‚îÄ‚îÄ‚îÄ Service Worker Registration ‚îÄ‚îÄ‚îÄ
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('sw.js').catch(() => {});
  }

})();
</script>
</body>
</html>
